# Tolles-Lawson Theory

## Background

Airborne magnetic surveys measure the Earth's total magnetic field using a scalar
magnetometer (typically an optically-pumped or proton-precession sensor) mounted on
the aircraft. The sensor records the true geophysical field **plus** interference
generated by the aircraft itself. Removing this aircraft-induced interference is
called **aeromagnetic compensation**.

The Tolles-Lawson model (Tolles & Lawson, 1950)
is the industry-standard linear model for this compensation. It decomposes
aircraft-induced interference into three physically distinct sources.

---

## Physical Model

Let $\mathbf{B}_\text{total}$ be the field measured by the scalar sensor and
$\mathbf{B}_\text{Earth}$ be the true geophysical field. The aircraft contribution is:

$$
\mathbf{B}_\text{aircraft} = \mathbf{B}_\text{perm} + \mathbf{B}_\text{ind} + \mathbf{B}_\text{eddy}
$$

### Permanent magnetization

Ferromagnetic structural components (steel frames, engine blocks, etc.) carry a
fixed remanent magnetization that is independent of the Earth's field. Because the
aircraft rotates relative to the sensor, the projection of this fixed vector onto
the sensor axis depends only on aircraft attitude — captured by the direction cosines
$(\cos_x,\, \cos_y,\, \cos_z)$:

$$
B_\text{perm} = p_1 \cos_x + p_2 \cos_y + p_3 \cos_z
$$

### Induced magnetization

Soft-iron components (landing gear, fuel tanks, etc.) develop a magnetization
proportional to the inducing field — the Earth's field — projected onto each axis.
The induced field at the sensor is a bilinear function of pairs of direction cosines,
giving the six unique entries of the symmetric outer product
$\cos_i \cos_j$, $i \leq j$:

$$
B_\text{ind} = \sum_{i \leq j} \, q_{ij}\, \cos_i \cos_j
$$

The six terms are:
$\cos_x^2,\; \cos_x\cos_y,\; \cos_x\cos_z,\; \cos_y^2,\; \cos_y\cos_z,\; \cos_z^2$.

!!! note "Why keep $\cos_z^2$?"
    The three squared terms satisfy $\cos_x^2 + \cos_y^2 + \cos_z^2 = 1$, so the
    full set of six is linearly dependent.  Rather than drop one term
    (an arbitrary choice), `lmc` retains all six and handles collinearity through
    ridge regression when `use_ridge = True`.

### Eddy-current fields

Time-varying magnetic flux through conducting airframe panels and wings induces
eddy currents, which in turn produce secondary magnetic fields.  The magnitude is
proportional to the rate of change of the induced field, making the eddy terms
products of a direction cosine with a cosine time-derivative $\dot{\cos}_j$:

$$
B_\text{eddy} = \sum_{i,\, j} \, e_{ij}\, \cos_i \, \dot{\cos}_j
$$

All nine combinations of $i, j \in \{x, y, z\}$ contribute, giving nine eddy
terms.

### IMU Angular-Rate Substitution

The time derivative of a direction cosine vector is given by the cross-product of
the angular velocity with the cosine vector:

$$
\dot{\mathbf{c}} = \boldsymbol{\omega} \times \mathbf{c}
$$

where $\boldsymbol{\omega} = (\omega_\text{roll}, \omega_\text{pitch}, \omega_\text{yaw})$
are the IMU body-frame angular rates. Expanding each component in index notation:

$$
\dot{c}_j = \sum_k \sum_\ell \varepsilon_{jk\ell}\, \omega_k\, c_\ell
$$

This shows that each $\dot{c}_j$ is a **linear combination** of the three angular
rates, with direction-cosine amplitudes as coefficients. Because each $\dot{c}_j$
is linear in $\boldsymbol{\omega}$, the angular rates excite eddy currents through
the same physical mechanisms as the true cosine time-derivatives, and because the
relationship is linear, the least-squares regression can absorb the transformation
— the fitted coefficients take on different numerical values, but the model's
explanatory power and compensation accuracy are preserved.

In practice, IMU angular rates typically have much lower noise than numerically
differentiated direction cosines, are available at high sample rates, and are
present in all flight datasets. Numerical differentiation via `numpy.gradient` can
amplify sensor noise and is sensitive to sampling rate irregularities. Setting
`use_imu_rates=True` in `PipelineConfig` avoids both artifacts by substituting IMU
body-rate channels directly into the eddy-current columns of the A-matrix
(see Gnadt et al., 2022).

!!! note
    Because the linear transformation relating $\boldsymbol{\omega}$ and
    $\dot{\mathbf{c}}$ is absorbed into the fitted coefficients, the coefficient
    magnitudes obtained with `use_imu_rates=True` are not directly comparable to
    those obtained with numerical differentiation. The compensation accuracy is
    equivalent; only the coefficient interpretation differs.

---

## Direction Cosines

A three-axis fluxgate magnetometer co-mounted with the scalar sensor provides the
vector field components $(B_x, B_y, B_z)$ in the aircraft body frame.  The total
field magnitude $|\mathbf{B}|$ is measured by the scalar sensor.  The **direction
cosines** are simply the normalised components:

$$
\cos_x = \frac{B_x}{|\mathbf{B}|}, \qquad
\cos_y = \frac{B_y}{|\mathbf{B}|}, \qquad
\cos_z = \frac{B_z}{|\mathbf{B}|}
$$

They satisfy $\cos_x^2 + \cos_y^2 + \cos_z^2 = 1$ and encode only the
**attitude** of the aircraft relative to the Earth's field, stripped of the field
intensity.  This normalisation is key: it separates the geophysical signal
(encoded in $|\mathbf{B}|$) from the aircraft geometry (encoded in the cosines).

Time derivatives $\dot{\cos}_i = d\cos_i/dt$ are estimated numerically using
second-order central differences via `numpy.gradient`, with explicit time
coordinates to handle non-uniform sampling rates. Alternatively, pass
`use_imu_rates=True` to substitute IMU body-rate channels directly; see
[IMU Angular-Rate Substitution](#imu-angular-rate-substitution) for the physical
justification.

---

## Earth Field Baseline

The Tolles-Lawson regression requires a **target signal** $\delta B$ that
represents only the aircraft interference — free of the geophysical field.
Computing it requires a baseline estimate of what the Earth's field alone
would measure at each sample point:

$$
\delta B = B_\text{measured} - B_\text{Earth}
$$

where $B_\text{measured}$ is the raw scalar magnetometer reading and
$B_\text{Earth}$ is the estimated geophysical field magnitude.  This
$\delta B$ is the $\Delta B$ appearing in the regression equation below.

Two methods are supported, selected via `PipelineConfig.earth_field_method`.

### IGRF (primary)

The **International Geomagnetic Reference Field** (IGRF) is a standardised
spherical-harmonic model of the Earth's main magnetic field, published and
updated every five years by the International Association of Geomagnetism
and Aeronomy (IAGA).  Given geodetic latitude, longitude, altitude above the
WGS84 ellipsoid, and a date, IGRF returns the three vector components of the
main field in geodetic east ($B_e$), north ($B_n$), and up ($B_u$)
directions.  The scalar baseline is their Euclidean norm:

$$
B_\text{Earth} = \sqrt{B_e^2 + B_n^2 + B_u^2}
$$

IGRF is evaluated using the
[ppigrf](https://github.com/klaundal/ppigrf) library (IGRF-14 coefficients).
Because the main field varies on timescales of years, a single representative
date for the survey flight is sufficient; sub-day variation is negligible
relative to aeromagnetic survey accuracy requirements.

The date is supplied explicitly via `PipelineConfig.igrf_date` — it is not
inferred from the data timestamps.  This is intentional: the `time` column
records relative or absolute instrument time whose epoch may not correspond
to a calendar date, and making the geophysical reference explicit avoids
silent errors.

!!! note "Crustal and external fields"
    IGRF models only the **main field** generated by the Earth's liquid outer
    core.  Crustal remanence (lithospheric anomalies) and external sources
    (ionospheric and magnetospheric currents) are not included.  In practice,
    these are small compared with aircraft interference during a calibration
    manoeuvre, so IGRF is an appropriate baseline for compensation purposes.
    Survey-grade anomaly mapping requires additional steps beyond the scope
    of this library.

### Steady-mean fallback

When IGRF is unavailable or inappropriate (e.g. altitude data are absent, or
a local absolute reference is preferred), a simpler baseline can be estimated
from the data itself.  During the **steady** segments of the calibration
manoeuvre — straight, level, unaccelerated flight — the aircraft attitude is
nearly constant and interference terms change slowly.  The mean scalar reading
over those segments approximates the local geophysical field:

$$
B_\text{Earth} \approx \overline{B_\text{measured}}\big|_\text{steady}
$$

This produces a **constant** baseline for the entire flight, so $\delta B$
becomes a mean-centred version of $B_\text{measured}$.  It is less accurate
than IGRF because it conflates the geophysical field with any interference
present during the steady segments, but it requires no external model and is
robust to missing positional metadata.

Steady segments are identified by the caller via the `steady_mask` boolean
parameter of `compute_interference`.  If no mask is provided, all samples
contribute to the mean.

---

## The Design Matrix (A-matrix)

The full Tolles-Lawson interference model is linear in the 18 derived features.
`build_feature_matrix` assembles these into a design matrix $\mathbf{A}$ with one
row per measurement epoch and one column per feature.

Three term sets are supported, selected via `PipelineConfig.model_terms`:

| `model_terms` | Terms included | Columns |
|:---:|---|:---:|
| `"a"` | Permanent only | 3 |
| `"b"` | Permanent + induced | 9 |
| `"c"` | Permanent + induced + eddy | 18 |

The full column layout for `"c"`:

$$
\mathbf{A} = \Bigl[
\underbrace{\cos_x,\; \cos_y,\; \cos_z}_{\text{permanent (3)}},\;
\underbrace{\cos_x^2,\; \cos_x\cos_y,\; \cos_x\cos_z,\; \cos_y^2,\; \cos_y\cos_z,\; \cos_z^2}_{\text{induced (6)}},\;
\underbrace{\cos_x\dot{\cos}_x,\; \cos_x\dot{\cos}_y,\; \ldots,\; \cos_z\dot{\cos}_z}_{\text{eddy (9)}}
\Bigr]
$$

---

## Regression

Given a compensation manoeuvre (a flight pattern designed to excite all interference
terms), the per-sample interference signal $\delta B$ (see
[Earth Field Baseline](#earth-field-baseline)) is modelled as:

$$
\Delta B = \mathbf{A}\,\boldsymbol{\beta} + \boldsymbol{\varepsilon}
$$

where $\boldsymbol{\beta} \in \mathbb{R}^k$ is the vector of Tolles-Lawson
coefficients ($k = 3, 9$, or $18$) and $\boldsymbol{\varepsilon}$ is measurement
noise.

### Ordinary least squares

The OLS estimate minimises the residual sum of squares:

$$
\hat{\boldsymbol{\beta}} = \bigl(\mathbf{A}^\top \mathbf{A}\bigr)^{-1}
                            \mathbf{A}^\top \Delta B
$$

### Ridge regression

When the induced terms are nearly collinear (as noted above), the Gram matrix
$\mathbf{A}^\top\mathbf{A}$ can be ill-conditioned.  Ridge regression adds an
$L_2$ penalty controlled by `PipelineConfig.ridge_alpha` ($\alpha$):

$$
\hat{\boldsymbol{\beta}}_\text{ridge} =
    \bigl(\mathbf{A}^\top \mathbf{A} + \alpha\,\mathbf{I}\bigr)^{-1}
    \mathbf{A}^\top \Delta B
$$

### Compensation

Once $\hat{\boldsymbol{\beta}}$ is estimated on calibration data, survey
measurements are compensated by subtracting the predicted interference:

$$
B_\text{compensated} = B_\text{measured} - \mathbf{A}\,\hat{\boldsymbol{\beta}}
$$

---

## References

- Tolles, W. E., & Lawson, J. D. (1950). *Magnetic compensation of MAD equipped aircraft*.
  Airborne Instruments Lab. Inc., Mineola, NY. Report 201-1.
- Leliak, P. (1961). Identification and evaluation of magnetic-field sources of magnetic
  airborne detector equipped aircraft. *IRE Transactions on Aerospace and Navigational
  Electronics*, ANE-8(3), 95–105.
- Noriega, G. (2011). Performance measures in aeromagnetic compensation.
  *The Leading Edge*, 30(10), 1122–1127.
- Alken, P., et al. (2021). International Geomagnetic Reference Field: the
  thirteenth generation. *Earth, Planets and Space*, 73(49).
  [DOI: 10.1186/s40623-020-01288-x](https://doi.org/10.1186/s40623-020-01288-x)
- Gnadt, A. R., Wollaber, A. B., & Nielsen, A. P. (2022). Derivation and extensions
  of the Tolles-Lawson model for aeromagnetic compensation. *arXiv preprint*.
  [DOI: 10.48550/arXiv.2212.09899](https://doi.org/10.48550/arXiv.2212.09899)
