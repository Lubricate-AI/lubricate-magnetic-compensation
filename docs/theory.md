# Tolles-Lawson Theory

## Background

Airborne magnetic surveys measure the Earth's total magnetic field using a scalar
magnetometer (typically an optically-pumped or proton-precession sensor) mounted on
the aircraft. The sensor records the true geophysical field **plus** interference
generated by the aircraft itself. Removing this aircraft-induced interference is
called **aeromagnetic compensation**.

The Tolles-Lawson model ([Tolles & Lawson, 1950](https://doi.org/10.1029/TR031i003p00395))
is the industry-standard linear model for this compensation. It decomposes
aircraft-induced interference into three physically distinct sources.

---

## Physical Model

Let $\mathbf{B}_\text{total}$ be the field measured by the scalar sensor and
$\mathbf{B}_\text{Earth}$ be the true geophysical field. The aircraft contribution is:

$$
\mathbf{B}_\text{aircraft} = \mathbf{B}_\text{perm} + \mathbf{B}_\text{ind} + \mathbf{B}_\text{eddy}
$$

### Permanent magnetization

Ferromagnetic structural components (steel frames, engine blocks, etc.) carry a
fixed remanent magnetization that is independent of the Earth's field. Because the
aircraft rotates relative to the sensor, the projection of this fixed vector onto
the sensor axis depends only on aircraft attitude — captured by the direction cosines
$(\cos_x,\, \cos_y,\, \cos_z)$:

$$
B_\text{perm} = p_1 \cos_x + p_2 \cos_y + p_3 \cos_z
$$

### Induced magnetization

Soft-iron components (landing gear, fuel tanks, etc.) develop a magnetization
proportional to the inducing field — the Earth's field — projected onto each axis.
The induced field at the sensor is a bilinear function of pairs of direction cosines,
giving the six unique entries of the symmetric outer product
$\cos_i \cos_j$, $i \leq j$:

$$
B_\text{ind} = \sum_{i \leq j} \, q_{ij}\, \cos_i \cos_j
$$

The six terms are:
$\cos_x^2,\; \cos_x\cos_y,\; \cos_x\cos_z,\; \cos_y^2,\; \cos_y\cos_z,\; \cos_z^2$.

!!! note "Why keep $\cos_z^2$?"
    The three squared terms satisfy $\cos_x^2 + \cos_y^2 + \cos_z^2 = 1$, so the
    full set of six is linearly dependent.  Rather than drop one term
    (an arbitrary choice), `lmc` retains all six and handles collinearity through
    ridge regression when `use_ridge = True`.

### Eddy-current fields

Time-varying magnetic flux through conducting airframe panels and wings induces
eddy currents, which in turn produce secondary magnetic fields.  The magnitude is
proportional to the rate of change of the induced field, making the eddy terms
products of a direction cosine with a cosine time-derivative $\dot{\cos}_j$:

$$
B_\text{eddy} = \sum_{i,\, j} \, e_{ij}\, \cos_i \, \dot{\cos}_j
$$

All nine combinations of $i, j \in \{x, y, z\}$ contribute, giving nine eddy
terms.

---

## Direction Cosines

A three-axis fluxgate magnetometer co-mounted with the scalar sensor provides the
vector field components $(B_x, B_y, B_z)$ in the aircraft body frame.  The total
field magnitude $|\mathbf{B}|$ is measured by the scalar sensor.  The **direction
cosines** are simply the normalised components:

$$
\cos_x = \frac{B_x}{|\mathbf{B}|}, \qquad
\cos_y = \frac{B_y}{|\mathbf{B}|}, \qquad
\cos_z = \frac{B_z}{|\mathbf{B}|}
$$

They satisfy $\cos_x^2 + \cos_y^2 + \cos_z^2 = 1$ and encode only the
**attitude** of the aircraft relative to the Earth's field, stripped of the field
intensity.  This normalisation is key: it separates the geophysical signal
(encoded in $|\mathbf{B}|$) from the aircraft geometry (encoded in the cosines).

Time derivatives $\dot{\cos}_i = d\cos_i/dt$ are estimated numerically using
second-order central differences via `numpy.gradient`, with explicit time
coordinates to handle non-uniform sampling rates.

---

## The Design Matrix (A-matrix)

The full Tolles-Lawson interference model is linear in the 18 derived features.
`build_feature_matrix` assembles these into a design matrix $\mathbf{A}$ with one
row per measurement epoch and one column per feature.

Three term sets are supported, selected via `PipelineConfig.model_terms`:

| `model_terms` | Terms included | Columns |
|:---:|---|:---:|
| `"a"` | Permanent only | 3 |
| `"b"` | Permanent + induced | 9 |
| `"c"` | Permanent + induced + eddy | 18 |

The full column layout for `"c"`:

$$
\mathbf{A} = \Bigl[
\underbrace{\cos_x,\; \cos_y,\; \cos_z}_{\text{permanent (3)}},\;
\underbrace{\cos_x^2,\; \cos_x\cos_y,\; \cos_x\cos_z,\; \cos_y^2,\; \cos_y\cos_z,\; \cos_z^2}_{\text{induced (6)}},\;
\underbrace{\cos_x\dot{\cos}_x,\; \cos_x\dot{\cos}_y,\; \ldots,\; \cos_z\dot{\cos}_z}_{\text{eddy (9)}}
\Bigr]
$$

---

## Regression

Given a compensation manoeuvre (a flight pattern designed to excite all interference
terms), the scalar residual between the measured field and a low-noise reference field
is modelled as:

$$
\Delta B = \mathbf{A}\,\boldsymbol{\beta} + \boldsymbol{\varepsilon}
$$

where $\boldsymbol{\beta} \in \mathbb{R}^k$ is the vector of Tolles-Lawson
coefficients ($k = 3, 9$, or $18$) and $\boldsymbol{\varepsilon}$ is measurement
noise.

### Ordinary least squares

The OLS estimate minimises the residual sum of squares:

$$
\hat{\boldsymbol{\beta}} = \bigl(\mathbf{A}^\top \mathbf{A}\bigr)^{-1}
                            \mathbf{A}^\top \Delta B
$$

### Ridge regression

When the induced terms are nearly collinear (as noted above), the Gram matrix
$\mathbf{A}^\top\mathbf{A}$ can be ill-conditioned.  Ridge regression adds an
$L_2$ penalty controlled by `PipelineConfig.ridge_alpha` ($\alpha$):

$$
\hat{\boldsymbol{\beta}}_\text{ridge} =
    \bigl(\mathbf{A}^\top \mathbf{A} + \alpha\,\mathbf{I}\bigr)^{-1}
    \mathbf{A}^\top \Delta B
$$

### Compensation

Once $\hat{\boldsymbol{\beta}}$ is estimated on calibration data, survey
measurements are compensated by subtracting the predicted interference:

$$
B_\text{compensated} = B_\text{measured} - \mathbf{A}\,\hat{\boldsymbol{\beta}}
$$

---

## References

- Tolles, W. E., & Lawson, J. D. (1950). *Magnetic compensation of MAD equipped aircraft*.
  Airborne Instruments Laboratory, Report.
  [DOI: 10.1029/TR031i003p00395](https://doi.org/10.1029/TR031i003p00395)
- Leliak, P. (1961). Identification and evaluation of magnetic-field sources of magnetic
  airborne detector equipped aircraft. *IRE Transactions on Aerospace and Navigational
  Electronics*, ANE-8(3), 95–105.
- Noriega, G. (2011). Performance measures in aeromagnetic compensation.
  *The Leading Edge*, 30(10), 1122–1127.
